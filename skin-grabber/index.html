<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Skin Grabber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card shadow p-4" style="max-width: 420px; width: 100%;">
            <div class="d-flex justify-content-center mb-3">
                <img id="avatarImg" src="https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay" alt="Steve" class="rounded-circle border border-3 border-white shadow" style="width:72px;height:72px;margin-top:-48px;background:#fff;">
            </div>
            <h4 class="text-center fw-bold mb-3" style="font-family: 'Montserrat', Arial, sans-serif; color: #4e54c8;">Minecraft Skin Grabber</h4>
            <form id="skinForm" autocomplete="off">
                <div class="row g-2 align-items-center mb-3">
                    <div class="col-12 col-md-8">
                        <input type="text" class="form-control" id="username" required placeholder="Minecraft Username...">
                    </div>
                    <div class="col-6 col-md-4 d-grid">
                        <button class="btn btn-primary w-100" type="submit">
                            <span class="material-icons align-middle me-1">search</span>Get Skin
                        </button>
                    </div>
                    <div class="col-6 d-grid d-md-none mt-2">
                        <button id="clearBtn" class="btn btn-outline-secondary" type="button">
                            <span class="material-icons align-middle me-1">clear</span>Clear
                        </button>
                    </div>
                </div>
            </form>
            <div id="output" class="mt-3"></div>
            <div id="error" class="text-danger mt-3 fw-semibold"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Avatar image update logic
    (function() {
        function getCookie(name) {
            const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? decodeURIComponent(v.pop()) : null;
        }
        document.addEventListener('DOMContentLoaded', function() {
            const usernameInput = document.getElementById('username');
            const avatarImg = document.getElementById('avatarImg');
            const form = document.getElementById('skinForm');
            let lastUsername = '';

            async function updateAvatar(username) {
                if (!username) {
                    avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                    avatarImg.alt = "Steve";
                    return;
                }
                // Use Crafatar for fast avatar (requires UUID, not username)
                try {
                    const res = await fetch('https://corsproxy.io/?https://api.mojang.com/users/profiles/minecraft/' + encodeURIComponent(username));
                    if (res.ok) {
                        const data = await res.json();
                        avatarImg.src = "https://crafatar.com/avatars/" + encodeURIComponent(data.id) + "?size=72&overlay";
                        avatarImg.alt = username + "'s avatar";
                    } else {
                        avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                        avatarImg.alt = "Steve";
                    }
                } catch {
                    avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                    avatarImg.alt = "Steve";
                }
            }

            usernameInput.addEventListener('input', function() {
                const username = usernameInput.value.trim();
                if (username !== lastUsername) {
                    lastUsername = username;
                    clearTimeout(window.avatarTypingTimer);
                    window.avatarTypingTimer = setTimeout(function() {
                        updateAvatar(username);
                    }, 800);
                }
            });

            // Also update on submit in case user pastes and submits quickly
            form.addEventListener('submit', function(e) {
                const username = usernameInput.value.trim();
                updateAvatar(username);
            });

            // Reset to Steve on clear
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    avatarImg.src = "https://static.wikia.nocookie.net/minecraft_gamepedia/images/6/6e/Steve.png";
                    avatarImg.alt = "Steve";
                });
            }
        });
    })();
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('skinForm');
        const output = document.getElementById('output');
        const errorDiv = document.getElementById('error');
        const clearBtn = document.getElementById('clearBtn');
        const usernameInput = document.getElementById('username');
        const avatarImg = document.getElementById('avatarImg');
        let lastQueriedUsername = '';
        let typingTimer;
        const doneTypingInterval = 1500; // ms

        async function fetchAndDisplaySkin(username) {
            output.innerHTML = '';
            errorDiv.textContent = '';
            if (!username) {
                output.innerHTML = '';
                return;
            }
            output.innerHTML = '<div class="d-flex justify-content-center my-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            try {
                // Get UUID
                let userRes;
                try {
                    userRes = await fetch('https://corsproxy.io/?https://api.mojang.com/users/profiles/minecraft/' + encodeURIComponent(username));
                } catch (networkErr) {
                    throw new Error('Network error: Unable to reach Mojang API. Please check your connection or try again later.');
                }
                if (userRes.status === 429) {
                    throw new Error('CORSProxy limit reached. Please wait a few minutes before trying again.');
                }
                if (!userRes.ok) throw new Error('User not found');
                const userData = await userRes.json().catch(() => null);
                if (!userData || userData.error || !userData.id) throw new Error('User not found');
                // Get skin data
                let profileRes;
                try {
                    profileRes = await fetch('https://corsproxy.io/?https://sessionserver.mojang.com/session/minecraft/profile/' + userData.id);
                } catch (networkErr) {
                    throw new Error('Network error: Unable to fetch skin data. Please check your connection or try again later.');
                }
                if (profileRes.status === 429) {
                    throw new Error('CORSProxy limit reached. Please wait a few minutes before trying again.');
                }
                if (!profileRes.ok) throw new Error('Could not fetch skin data');
                const profileData = await profileRes.json();
                const prop = profileData.properties && profileData.properties[0];
                if (!prop || !prop.value) throw new Error('No skin data found.');
                const playerData = JSON.parse(atob(prop.value));
                let skinUrl = playerData.textures && playerData.textures.SKIN ? playerData.textures.SKIN.url : null;
                let capeUrl = playerData.textures && playerData.textures.CAPE ? playerData.textures.CAPE.url : null;
                // Ensure URLs use https
                if (skinUrl && skinUrl.startsWith('http://')) {
                    skinUrl = skinUrl.replace('http://', 'https://');
                }
                if (capeUrl && capeUrl.startsWith('http://')) {
                    capeUrl = capeUrl.replace('http://', 'https://');
                }
                if (!skinUrl) {
                    output.innerHTML = '<div class="alert alert-warning text-center">No skin found.</div>';
                    return;
                }
                let html = `
                <div class="card mb-3">
                    <div class="card-body d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                        <div class="text-center flex-grow-1" style="min-width: 120px;">
                            <h6 class="card-title fw-bold mb-2">Skin</h6>
                            <img class="img-fluid rounded shadow-sm mb-2" src="${skinUrl}" alt="Skin" style="max-width:120px;">
                        </div>
                        <div class="d-flex flex-column align-items-center align-items-md-end">
                            <button type="button" class="btn btn-success mt-2 w-100" id="downloadSkinBtn">
                                <span class="material-icons align-middle me-1">file_download</span>Download Skin
                            </button>
                        </div>
                    </div>
                </div>
                `;
                if (capeUrl) {
                    html += `
                    <div class="card mb-3">
                        <div class="card-body d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
                            <div class="text-center flex-grow-1" style="min-width: 80px;">
                                <h6 class="card-title fw-bold mb-2">Cape</h6>
                                <img class="img-fluid rounded shadow-sm mb-2" src="${capeUrl}" alt="Cape" style="max-width:80px;">
                            </div>
                            <div class="d-flex flex-column align-items-center align-items-md-end">
                                <button type="button" class="btn btn-info mt-2 w-100" id="downloadCapeBtn">
                                    <span class="material-icons align-middle me-1">file_download</span>Download Cape
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }
                output.innerHTML = html;

                // Download Skin Button
                const downloadSkinBtn = document.getElementById('downloadSkinBtn');
                if (downloadSkinBtn && skinUrl) {
                    downloadSkinBtn.addEventListener('click', function() {
                        fetch(skinUrl)
                            .then(res => res.blob())
                            .then(blob => {
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                // Use the exact username casing from Mojang API if available
                                let downloadName = 'skin';
                                if (userData && userData.name) {
                                    downloadName = userData.name;
                                }
                                a.download = downloadName + '.png';
                                document.body.appendChild(a);
                                a.click();
                                setTimeout(() => {
                                    URL.revokeObjectURL(url);
                                    a.remove();
                                }, 100);
                            });
                    });
                }
                // Download Cape Button
                const downloadCapeBtn = document.getElementById('downloadCapeBtn');
                if (downloadCapeBtn && capeUrl) {
                    downloadCapeBtn.addEventListener('click', function() {
                        fetch(capeUrl)
                            .then(res => res.blob())
                            .then(blob => {
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                let downloadName = 'cape';
                                if (userData && userData.name) {
                                    downloadName = userData.name + '-cape';
                                }
                                a.download = downloadName + '.png';
                                document.body.appendChild(a);
                                a.click();
                                setTimeout(() => {
                                    URL.revokeObjectURL(url);
                                    a.remove();
                                }, 100);
                            });
                    });
                }
            } catch (err) {
                output.innerHTML = '';
                if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
                    errorDiv.textContent = 'Network error: Unable to connect to the API. Please check your internet connection or try again later.';
                } else if (err.message && err.message.includes('CORSProxy limit reached')) {
                    errorDiv.textContent = err.message;
                } else {
                    errorDiv.textContent = err.message || 'An error occurred. Please try again.';
                }
            }
        }

        // Only fetch skin and update avatar after user stops typing for 1.5 seconds or submits
        function updateAvatarAfterTyping(username) {
            if (!username) {
                avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                avatarImg.alt = "Steve";
                return;
            }
            fetch('https://corsproxy.io/?https://api.mojang.com/users/profiles/minecraft/' + encodeURIComponent(username))
                .then(res => res.ok ? res.json() : null)
                .then(data => {
                    if (data && data.id) {
                        avatarImg.src = "https://crafatar.com/avatars/" + encodeURIComponent(data.id) + "?size=72&overlay";
                        avatarImg.alt = username + "'s avatar";
                    } else {
                        avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                        avatarImg.alt = "Steve";
                    }
                })
                .catch(() => {
                    avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                    avatarImg.alt = "Steve";
                });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = usernameInput.value.trim();
            lastQueriedUsername = username;
            fetchAndDisplaySkin(username);
            updateAvatarAfterTyping(username);
        });

        usernameInput.addEventListener('input', function() {
            clearTimeout(typingTimer);
            const username = usernameInput.value.trim();
            if (!username) {
                output.innerHTML = '';
                errorDiv.textContent = '';
                lastQueriedUsername = '';
                avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                avatarImg.alt = "Steve";
                return;
            }
            typingTimer = setTimeout(function() {
                if (username !== lastQueriedUsername) {
                    lastQueriedUsername = username;
                    fetchAndDisplaySkin(username);
                    updateAvatarAfterTyping(username);
                }
            }, doneTypingInterval);
        });

        usernameInput.addEventListener('keydown', function() {
            clearTimeout(typingTimer);
        });

        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                usernameInput.value = '';
                output.innerHTML = '';
                errorDiv.textContent = '';
                lastQueriedUsername = '';
                avatarImg.src = "https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=72&overlay";
                avatarImg.alt = "Steve";
            });
        }
    });
    </script>
    <!-- Warning Popup Modal -->
    <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning-subtle">
                    <h5 class="modal-title" id="warningModalLabel">
                        <span class="material-icons align-middle me-1 text-warning">warning</span>
                        Warning
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This tool uses unaffiliated third-party APIs such as Corsproxy and Crafatar and is not affiliated nor approved by Mojang or Microsoft.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">I Understand</button>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem('skinGrabberWarningShown')) {
            var warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
            warningModal.show();
            document.getElementById('warningModal').addEventListener('hidden.bs.modal', function() {
                localStorage.setItem('skinGrabberWarningShown', '1');
            });
        }
    });
    </script>
</body>
</html>
