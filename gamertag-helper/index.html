<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Gamertag Generator Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="avatar.js"></script>
    <script src="carousell.js"></script>
    <script src="responsive.js"></script>
</head>

<style>
    body {
        background: url('../nether.png');
        background-size: cover;
        background-position: center;
        transition: ease 2s;
    }
</style>

<body class="bg-light">

    <!-- Top Bar -->
    <div class="top-bar" style="position: fixed; width: 100%; z-index: 1030;">
        <link rel="stylesheet" href="../topbar.css">
        <link rel="stylesheet" href="../centerstage.css">
        <div class="centerstage">
            <img class="logo" src="../logo.png" alt="Logo">
        </div>
    </div>

    <!-- Main Content -->
    <div id="403msg" class="card p-2" style="position: absolute; width: 600px; top: 80px; left: 50%; transform: translate(-50%); font-size: small; z-index: 7;" hidden>
        This is a message that shows up when error 403 is returned through corsproxy. This means that the request is blocked by either Corsproxy, Microsoft or Mojang.
    </div>

    <div class="container d-flex justify-content-center min-vh-100">

        <div class="card shadow p-4" style="margin: 160px 0 80px 0; max-width: 600px; width: 100%; height: fit-content;">

            <div class="d-flex justify-content-center mb-4">
                <img id="avatarImg" src="https://crafatar.com/avatars/8667ba71b85a4004af54457a9734eed7?size=128&overlay" alt="Steve" class="rounded-circle border border-3 border-white shadow" style="width:100px;height:100px;margin-top:-64px;background:#fff;">
            </div>

            <h4 class="text-center fw-bold mb-3" id="bigcenter" style="font-family: 'Montserrat', Arial, sans-serif; color: #4e54c8;">Minecraft Gamertag Generator</h4>

            <form id="gamertagForm" autocomplete="off">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Choose at least one word from each group:</label>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <div class="fw-semibold mb-1">Primary Words</div>
                            <div class="row row-cols-3 row-cols-sm-4 row-cols-md-5 g-1" id="wordCheckboxes1">
                                <!-- Primary words will be generated by JavaScript -->
                                <script>
                                const primaryWords = [
                                    { value: "Epic", color: "primary" },
                                    { value: "Shadow", color: "danger" },
                                    { value: "Pixel", color: "secondary" },
                                    { value: "Dragon", color: "warning" },
                                    { value: "Ninja", color: "success" },
                                    { value: "Legend", color: "info" },
                                    { value: "Techno", color: "danger" },
                                    { value: "Prime", color: "info" },
                                    { value: "Super", color: "danger" },
                                    { value: "Cracked", color: "warning" },
                                    { value: "Mister", color: "dark" },
                                    { value: "Hyper", color: "danger" },
                                    { value: "The", color: "success" },
                                    { value: "Im", color: "info" },
                                    { value: "Speedy", color: "warning" }
                                ];

                                const wordCheckboxes1 = document.getElementById('wordCheckboxes1');
                                primaryWords.forEach(word => {
                                    const col = document.createElement('div');
                                    col.className = 'col mb-1';

                                    const input = document.createElement('input');
                                    input.type = 'checkbox';
                                    input.className = 'btn-check';
                                    input.id = `word1-${word.value}`;
                                    input.value = word.value;
                                    input.autocomplete = 'off';

                                    const label = document.createElement('label');
                                    label.className = `btn border-2 btn-outline-${word.color} w-100 fw-bold`;
                                    label.setAttribute('for', input.id);
                                    label.textContent = word.value;

                                    col.appendChild(input);
                                    col.appendChild(label);
                                    wordCheckboxes1.appendChild(col);
                                });
                                </script>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="customWord">Add a custom word (optional):</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="customWord" placeholder="Your custom word">
                                <button class="btn btn-outline-success" type="button" id="addToPrimaryBtn">
                                    <span class="material-icons align-middle me-1">arrow_upward</span>
                                </button>
                                <button class="btn btn-outline-info" type="button" id="addToEndingBtn">
                                    <span class="material-icons align-middle me-1">arrow_downward</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="fw-semibold mb-1">Ending Words</div>
                            <div class="row row-cols-3 row-cols-sm-4 row-cols-md-5 g-1" id="wordCheckboxes2">
                                <!-- Ending words will be generated by JavaScript -->
                                <script>
                                const endingWords = [
                                    { value: "Crafter", color: "primary" },
                                    { value: "Miner", color: "secondary" },
                                    { value: "Beast", color: "danger" },
                                    { value: "Wizard", color: "info" },
                                    { value: "Knight", color: "warning" },
                                    { value: "Fighter", color: "success" },
                                    { value: "Monster", color: "danger" },
                                    { value: "Frags", color: "dark" },
                                    { value: "Real", color: "success" },
                                    { value: "Combos", color: "primary" },
                                    { value: "Hammer", color: "warning" },
                                    { value: "Banner", color: "info" },
                                    { value: "Lightning", color: "warning" },
                                    { value: "Fire", color: "danger" }
                                ];

                                const wordCheckboxes2 = document.getElementById('wordCheckboxes2');
                                endingWords.forEach(word => {
                                    const col = document.createElement('div');
                                    col.className = 'col mb-1';

                                    const input = document.createElement('input');
                                    input.type = 'checkbox';
                                    input.className = 'btn-check';
                                    input.id = `word2-${word.value}`;
                                    input.value = word.value;
                                    input.autocomplete = 'off';

                                    const label = document.createElement('label');
                                    label.className = `btn border-2 btn-outline-${word.color} w-100 fw-bold`;
                                    label.setAttribute('for', input.id);
                                    label.textContent = word.value;

                                    col.appendChild(input);
                                    col.appendChild(label);
                                    wordCheckboxes2.appendChild(col);
                                });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-fill" type="submit">
                        <span class="material-icons align-middle">refresh</span>
                        Refresh
                    </button>
                    <button id="clearBtn" class="btn btn-outline-secondary flex-fill" type="button">
                        <span class="material-icons align-middle me-1">delete</span>Clear
                    </button>
                </div>
            </form>
            <div id="output" class="mt-3"></div>
            <div id="availabilityResult" class="mt-2"></div>
            <div id="gamertagHistory" class="mt-2"></div>
            <div id="error" class="text-danger mt-3 fw-semibold"></div>
        </div>
    </div>
    <script>
    // --- Feature 1: Show all available gamertags ---
    // Store checked gamertags and their availability
    if (!window.checkedGamertagsCache) {
        window.checkedGamertagsCache = {};
    }

    async function autoGenerateGamertag() {
        document.getElementById('error').textContent = '';
        document.getElementById('output').innerHTML = '';
        document.getElementById('availabilityResult').innerHTML = '';
        document.getElementById('gamertagHistory').innerHTML = '';

        if (!validateCheckboxGroups()) {
            document.getElementById('error').textContent = 'Please select at least one word from each group.';
            return;
        }

        const word1Checked = Array.from(document.querySelectorAll('#wordCheckboxes1 input:checked')).map(cb => cb.value);
        const word2Checked = Array.from(document.querySelectorAll('#wordCheckboxes2 input:checked')).map(cb => cb.value);

        let tried = [];
        let available = [];

        document.getElementById('output').innerHTML = `<div>Checking all combinations for availability...</div>`;
        document.getElementById('availabilityResult').innerHTML = '';

        for (let p of word1Checked) {
            for (let s of word2Checked) {
                let gamertag = p + s;
                tried.push(gamertag);

                // Check cache first
                if (window.checkedGamertagsCache.hasOwnProperty(gamertag)) {
                    if (window.checkedGamertagsCache[gamertag]) {
                        available.push(gamertag);
                    }
                    continue;
                }

                let isAvail = await checkAvailability(gamertag);
                window.checkedGamertagsCache[gamertag] = isAvail;
                if (isAvail) {
                    available.push(gamertag);
                }
            }
        }

        let outputHtml = '';
        if (available.length > 0) {
            outputHtml = `<div class="fw-bold">Available Gamertags:</div>`;
            outputHtml += `<div class="mt-2">` + available.map(gt => `<span class="badge bg-primary me-1">${gt}</span>`).join('') + `</div>`;
            document.getElementById('availabilityResult').innerHTML = `<span class="badge bg-success">Some available!</span>`;
        } else {
            outputHtml = `<div class="fw-bold">No available gamertag found. Tried: <span class="text-secondary" id="triedList">${tried.slice(0, 5).join(', ')}${tried.length > 5 ? ', ...' : ''}</span></div>`;
            if (tried.length > 5) {
                outputHtml += `<button class="btn btn-link p-0 ms-1" id="seeMoreBtn" style="font-size:0.95em;">See more</button>`;
                setTimeout(() => {
                    const btn = document.getElementById('seeMoreBtn');
                    if (btn) {
                        btn.addEventListener('click', function() {
                            document.getElementById('triedList').textContent = tried.join(', ');
                            btn.style.display = 'none';
                        });
                    }
                }, 0);
            }
            document.getElementById('availabilityResult').innerHTML = `<span class="badge bg-danger">None available</span>`;
        }
        document.getElementById('output').innerHTML = outputHtml;
    }

    // Debounce function to limit how often autoGenerateGamertag runs
    function debounce(fn, delay) {
        let timeout;
        return function(...args) {
            if (timeout) clearTimeout(timeout);
            timeout = setTimeout(() => {
                timeout = null;
                fn.apply(this, args);
            }, delay);
        };
    }
    const debouncedAutoGenerateGamertag = debounce(autoGenerateGamertag, 600);

    // Listen for checkbox changes for auto-generation
    document.querySelectorAll('#wordCheckboxes1 input, #wordCheckboxes2 input').forEach(cb => {
        cb.addEventListener('change', debouncedAutoGenerateGamertag);
    });

    // --- Feature 2: Add custom word with Primary/Ending buttons ---
    function addCustomWordToGroup(group) {
        const custom = document.getElementById('customWord').value.trim();
        if (!custom) return;

        // Prevent duplicates
        const groupId = group === "primary" ? "wordCheckboxes1" : "wordCheckboxes2";
        if (document.querySelector(`#${groupId} input[value="${custom}"]`)) {
            document.getElementById('customWord').value = '';
            return;
        }

        // Create new checkbox with Bootstrap button style
        const div = document.createElement('div');
        div.className = "col mb-1";
        const id = (group === "primary" ? "word1-" : "word2-") + custom.replace(/\s+/g, '');

        // Pick a random color from the same palette as the defaults
        const colors = ["primary", "secondary", "danger", "warning", "success", "info", "dark"];
        const color = colors[Math.floor(Math.random() * colors.length)];

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'btn-check';
        input.id = id;
        input.value = custom;
        input.checked = true;
        input.autocomplete = 'off';

        const label = document.createElement('label');
        label.className = `btn border-2 btn-outline-${color} w-100 fw-bold`;
        label.setAttribute('for', id);
        label.textContent = custom;

        div.appendChild(input);
        div.appendChild(label);
        document.getElementById(groupId).appendChild(div);

        // Listen for auto-generation on new checkbox
        div.querySelector('input').addEventListener('change', autoGenerateGamertag);

        document.getElementById('customWord').value = '';
        autoGenerateGamertag();
    }

    document.getElementById('addToPrimaryBtn').addEventListener('click', function() {
        addCustomWordToGroup("primary");
    });
    document.getElementById('addToEndingBtn').addEventListener('click', function() {
        addCustomWordToGroup("ending");
    });

    // Keep form submit for manual generation (optional)
    document.getElementById('gamertagForm').addEventListener('submit', function(e) {
        e.preventDefault();
        autoGenerateGamertag();
    });

    document.getElementById('clearBtn').addEventListener('click', function() {
        document.querySelectorAll('#wordCheckboxes1 input, #wordCheckboxes2 input').forEach(cb => cb.checked = false);
        // Remove custom words
        document.querySelectorAll('#wordCheckboxes1 input, #wordCheckboxes2 input').forEach(cb => {
            if (![
                'Epic','Shadow','Pixel','Dragon','Ninja','Legend','Techno','Prime','Super','Cracked','Mister','Hyper','The','Im','Speedy',
                'Crafter','Miner','Beast','Wizard','Knight','Fighter','Monster','Frags','Real','Combos','Hammer','Banner','Lightning','Fire'
            ].includes(cb.value)) {
                cb.parentElement.remove();
            }
        });
        if (window.lastCheckedGamertag) {
            window.lastCheckedGamertag = null;
        }
        document.getElementById('customWord').value = '';
        document.getElementById('output').innerHTML = '';
        document.getElementById('availabilityResult').innerHTML = '';
        document.getElementById('error').textContent = '';
        // Optionally re-check defaults
        document.querySelector('#word1-Epic').checked = true;
        document.querySelector('#word2-Crafter').checked = true;
        autoGenerateGamertag();
    });

    // Optionally, check at least one checkbox by default for usability
    document.querySelector('#word1-Epic').checked = true;
    document.querySelector('#word2-Crafter').checked = true;
    // Initial auto-generate

    // autoGenerateGamertag();

    // --- Mojang API availability check via corsproxy.io ---

    // --- Prevent rechecking already checked combinations ---
    // Store checked combinations in a Set
    let checkedCombinations = new Set();

    // (No-op: do not reset checkedCombinations)

    // Listen for changes to reset checked combinations
    document.querySelectorAll('#wordCheckboxes1 input, #wordCheckboxes2 input').forEach(cb => {
        cb.addEventListener('change', resetCheckedCombinations);
    });

    // Also reset when clearing
    document.getElementById('clearBtn').addEventListener('click', resetCheckedCombinations);

    // skip already checked combos
    // (Removed duplicate/conflicting autoGenerateGamertag function here)
    async function checkAvailability(gamertag) {
        // Mojang API: https://api.mojang.com/users/profiles/minecraft/<username>
        // If 204 or 404, it's available. If 200, it's taken.
        const url = `https://corsproxy.io/?https://api.mojang.com/users/profiles/minecraft/${encodeURIComponent(gamertag)}`;
        try {
            // Try fetch first
            if (window.fetch) {
                const res = await fetch(url, { method: 'GET' });
                if (res.status === 204 || res.status === 404) {
                    return true; // Available
                }

                if (res.status === 403 || res.status === 404) {
                    document.getElementById('403msg').hidden = false;
                    setTimeout(()=>{
                        document.getElementById('403msg').hidden = true;
                    }, 10000);
                }

                if (res.status === 200) {
                    return false; // Taken
                }
                return false;
            } else {
                // Fallback to XMLHttpRequest
                return await new Promise((resolve) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', url);
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 204 || xhr.status === 404) {
                                resolve(true);
                            } else if (xhr.status === 200) {
                                resolve(false);
                            } else {
                                resolve(false);
                            }
                        }
                    };
                    xhr.onerror = function () {
                        resolve(false);
                    };
                    xhr.send();
                });
            }
        } catch (e) {
            // On error, treat as unavailable but do NOT cache this gamertag
            document.getElementById('error').textContent = "error fetching from proxy? timed out";
            // Remove from cache if present (ensure not saved as unavailable)
            if (window.checkedGamertagsCache && window.checkedGamertagsCache.hasOwnProperty(gamertag)) {
                delete window.checkedGamertagsCache[gamertag];
            }
            return false;
        }
    }

    // Ensure at least one checkbox is checked in each group
    function validateCheckboxGroups() {
        const word1Checked = document.querySelectorAll('#wordCheckboxes1 input:checked').length;
        const word2Checked = document.querySelectorAll('#wordCheckboxes2 input:checked').length;
        return word1Checked > 0 && word2Checked > 0;
    }
    </script>

    <!-- Warning Popup Modal -->
    <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning-subtle">
                    <h5 class="modal-title" id="warningModalLabel">
                        <span class="material-icons align-middle me-1 text-warning">warning</span>
                        Warning
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This tool uses unaffiliated third-party APIs such as Corsproxy and Crafatar and is not affiliated nor approved by Mojang or Microsoft.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">I Understand</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
